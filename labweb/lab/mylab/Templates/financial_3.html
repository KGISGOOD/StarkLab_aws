<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>基金推薦小幫手</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
    }

    .card-container {
      max-width: 900px;
      margin: 20px auto;
      background-color: #fff;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card-container p.intro {
      font-size: 16px;
      color: #34495e;
      margin-top: 10px;
      font-weight: normal;
    }

    .card-container form {
      margin-top: 20px;
    }

    p {
      font-weight: bold;
      margin-top: 20px;
      color: #34495e;
    }

    label {
      display: block;
      margin: 5px 0 10px 20px;
      color: #555;
    }

    button {
      margin-top: 20px;
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background-color: #2980b9;
    }

    #result {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 25px;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .filter-box {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .filter-box label {
      font-size: 16px;
      font-weight: bold;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-box select {
      padding: 10px 14px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
      min-width: 200px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background-color: #fff;
      border-radius: 6px;
      overflow: hidden;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
      font-size: 15px;
    }

    th {
      background-color: #ecf0f1;
    }

    .risk-conservative {
      color: #27ae60;
      font-weight: bold;
    }

    .risk-balanced {
      color: #e67e22;
      font-weight: bold;
    }

    .risk-aggressive {
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>基金推薦小幫手</h1>

  <div class="card-container">
    <p class="intro">
      您好，為使本次所推薦的基金符合您的的風險承受度以及投資偏好，在投資前請幫忙回答以下問題，謝謝!
    </p>

    <form id="questionnaireForm">
      <p>1. 當市場出現波動時，您會如何反應？</p>
      <label><input type="radio" name="q1" value="1"> (A) 擔心並尋求減少風險 </label><br>
      <label><input type="radio" name="q1" value="2"> (B) 感到不安，但會堅持不變 </label><br>
      <label><input type="radio" name="q1" value="3"> (C) 尋找更多投資機會 </label><br>

      <p>2. 若您的投資損失了20%，您會怎麼做？</p>
      <label><input type="radio" name="q2" value="1"> (A) 立即賣出，以減少損失 </label><br>
      <label><input type="radio" name="q2" value="2"> (B) 保持不變，等待市場回升 </label><br>
      <label><input type="radio" name="q2" value="3"> (C) 購買更多，視為進場的好機會 </label><br>

      <p>3. 請問您對長期投資（例如5年以上）的態度如何？</p>
      <label><input type="radio" name="q3" value="1"> (A) 不願意承擔過多風險 </label><br>
      <label><input type="radio" name="q3" value="2"> (B) 接受適度的波動並追求穩定回報 </label><br>
      <label><input type="radio" name="q3" value="3"> (C) 不太偏好長期投資 </label><br>

      <p>4. 請問您投資的主要目的是什麼？</p>
      <label><input type="radio" name="q4" value="1"> (A) 穩定資金 </label><br>
      <label><input type="radio" name="q4" value="2"> (B) 提早退休、教育基金 </label><br>
      <label><input type="radio" name="q4" value="3"> (C) 高風險快速財富自由 </label><br>

      <p>5. 若有充裕資金，您會選擇哪些投資標的？</p>
      <label><input type="radio" name="q5" value="1"> (A) 低風險、穩定回報 </label><br>
      <label><input type="radio" name="q5" value="2"> (B) 穩健型資產 </label><br>
      <label><input type="radio" name="q5" value="3"> (C) 高風險、高回報資產 </label><br>

      <p>6. 可接受的投資回報率區間？</p>
      <label><input type="radio" name="q6" value="1"> (A) -5%至5% </label><br>
      <label><input type="radio" name="q6" value="2"> (B) -15%至15% </label><br>
      <label><input type="radio" name="q6" value="3"> (C) -30%至30% </label><br>

      <p>7. 是否曾經歷過重大的投資損失？</p>
      <label><input type="radio" name="q7" value="1"> (A) 是，並且對風險有顧慮 </label><br>
      <label><input type="radio" name="q7" value="2"> (B) 是，但仍願意投資 </label><br>
      <label><input type="radio" name="q7" value="3"> (C) 尚未有投資經驗 </label><br>

      <p>8. 您偏好投資什麼樣的資產？</p>
      <label><input type="radio" name="q8" value="1"> (A) 國債、國庫券 </label><br>
      <label><input type="radio" name="q8" value="2"> (B) 股票與債券混合基金 </label><br>
      <label><input type="radio" name="q8" value="3"> (C) 科技股、AI概念股 </label><br>

      <p>9. 預期的投資期限？</p>
      <label><input type="radio" name="q9" value="1"> (A) 少於1年 </label><br>
      <label><input type="radio" name="q9" value="2"> (B) 1-3年 </label><br>
      <label><input type="radio" name="q9" value="3"> (C) 超過5年 </label><br>

      <p>10. 您的投資經驗？</p>
      <label><input type="radio" name="q10" value="1"> (A) 沒有經驗 </label><br>
      <label><input type="radio" name="q10" value="2"> (B) 有一些經驗 </label><br>
      <label><input type="radio" name="q10" value="3"> (C) 有豐富經驗 </label><br>
      <button type="button" onclick="submitTotalScore()">送出</button>
    </form>
  </div>

  <div id="result" style="display: none;">
    <h2>推薦結果</h2>
    <p><strong>風險等級:</strong> <span id="riskLevel"></span></p>
    <p><strong>總分:</strong> <span id="totalScore"></span></p>

    <div class="filter-box">
      <label>
        📁 類型：
        <select id="industrySelect">
          <option>請選擇類型</option>
        </select>
      </label>
      <label>
        🌍 主要投資區域：
        <select id="countrySelect">
          <option>請選擇主要投資區域</option>
        </select>
      </label>
    </div>

    <h3>推薦的基金：</h3>
    <table id="fundTable">
      <thead>
        <tr>
          <th>基金名稱</th>
          <th>類型</th>
          <th>主要投資區域</th>
          <th>標準差</th>
          <th>夏普值</th>
          <th>Beta 值</th>
          <th>三個月報酬</th>
          <th>今年來報酬率</th>
        </tr>
      </thead>
      <tbody id="fundTableBody"></tbody>
    </table>
  </div>

  <div id="chatBox"
    style="display: none; max-width: 900px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px;">

    <h3>💬 問問AI小幫手</h3>
    <div id="chatArea"
      style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fafafa;">
    </div>
    <input type="text" id="chatInput" placeholder="輸入你的問題..."
      style="width: 80%; padding: 10px; border-radius: 6px; border: 1px solid #ccc;" />
    <button onclick="sendChat()"
      style="padding: 10px 16px; margin-left: 10px; background-color: #3498db; color: #fff; border: none; border-radius: 6px;">送出</button>
  </div>

</body>

{% load static %}
<script>
  let csvData = [];
  let currentRecommendations = [];

    document.addEventListener("DOMContentLoaded", function () {
       fetch("{% static '/基金資料彙整1140222.csv' %}")
       // fetch("基金資料彙整1140222.csv")
            .then(response => response.text())
            .then(text => {
                parseCSV(text);
                populateDropdowns();
            })
            .catch(error => console.error("無法讀取 CSV:", error));
    });



  function parseCSV(text) {
    const lines = text.trim().split("\n");
    const headers = lines[0].replace("\ufeff", "").split(",");

    const nameIndex = headers.indexOf("標的名稱");
    const industryIndex = headers.indexOf("類型1");
    const countryIndex = headers.indexOf("投資區域");
    const stdDevIndex = headers.indexOf("標準差％");
    const sharpeIndex = headers.indexOf("夏普值");
    const betaIndex = headers.indexOf("β係數");
    const r3mIndex = headers.indexOf("三個月％");
    const ytdIndex = headers.indexOf("今年來％");

    csvData = lines.slice(1).map(line => {
      const columns = line.split(",");
      return {
        name: columns[nameIndex]?.trim(),
        stdDev: parseFloat(columns[stdDevIndex]) || 0,
        sharpe: parseFloat(columns[sharpeIndex]) || 0,
        beta: parseFloat(columns[betaIndex]) || 0,
        r3m: parseFloat(columns[r3mIndex]) || 0,
        rYTD: parseFloat(columns[ytdIndex]) || 0,
        industry: columns[industryIndex]?.trim(),
        country: columns[countryIndex]?.trim()
      };
    });

  }

  function populateDropdowns() {
    const industries = [...new Set(csvData.map(d => d.industry).filter(Boolean))].sort();
    const countries = [...new Set(csvData.map(d => d.country).filter(Boolean))].sort();

    const industrySelect = document.getElementById("industrySelect");
    const countrySelect = document.getElementById("countrySelect");

    industrySelect.innerHTML = "<option>請選擇類型</option>" + industries.map(i => `<option>${i}</option>`).join("");
    countrySelect.innerHTML = "<option>請選擇主要投資區域</option>" + countries.map(c => `<option>${c}</option>`).join("");
  }

  function submitTotalScore() {
    let totalScore = 0;
    let allAnswered = true;

    for (let i = 1; i <= 10; i++) {
      const selected = document.querySelector(`input[name="q${i}"]:checked`);
      if (!selected) {
        allAnswered = false;
        break;
      }
      totalScore += parseInt(selected.value);
    }

    if (!allAnswered) {
      alert("請完成所有問題！");
      return;
    }

    const riskLevel = determineRiskLevel(totalScore);
    document.getElementById("totalScore").textContent = totalScore;

    const riskElem = document.getElementById("riskLevel");
    riskElem.textContent = riskLevel;
    riskElem.className = "";
    if (riskLevel === "保守型") riskElem.classList.add("risk-conservative");
    if (riskLevel === "穩健型") riskElem.classList.add("risk-balanced");
    if (riskLevel === "積極型") riskElem.classList.add("risk-aggressive");

    const rawRecommendations = csvData.filter(f =>
      riskLevel === "保守型"
        ? f.stdDev <= 12 && f.sharpe >= 0.35 && f.beta >= 0 && f.beta <= 1 && (f.r3m >= 0 || f.rYTD >= 4)
        : riskLevel === "穩健型"
          ? f.stdDev <= 18 && f.sharpe >= 0.25 && f.beta >= 0.7 && f.beta <= 1.0 && (f.r3m >= -3 || f.rYTD >= 8)
          : riskLevel === "積極型"
            ? f.stdDev >= 18 && f.sharpe >= 0.1 && f.beta >= 1.0 && f.beta <= 2.0 && (f.r3m >= -5 || f.rYTD >= 10)
            : false
    );

    // ✅ 基金名稱前10字相同的只保留報酬率最高
    const seen = new Map();
    rawRecommendations.forEach(fund => {
      const key = fund.name.slice(0, 10);
      if (!seen.has(key) || seen.get(key).rYTD < fund.rYTD) {
        seen.set(key, fund);
      }
    });
    currentRecommendations = Array.from(seen.values());

    populateDropdowns();
    filterByDropdowns();
    document.getElementById("result").style.display = "block";
    document.getElementById("chatBox").style.display = "block";

  }

  function determineRiskLevel(score) {
    if (score <= 16) return "保守型";
    if (score <= 23) return "穩健型";
    return "積極型";
  }

  function filterByDropdowns() {
    const selectedIndustry = document.getElementById("industrySelect").value;
    const selectedCountry = document.getElementById("countrySelect").value;

    const filtered = currentRecommendations.filter(fund =>
      (selectedIndustry === "請選擇類型" || fund.industry === selectedIndustry) &&
      (selectedCountry === "請選擇主要投資區域" || fund.country === selectedCountry)
    );

    const sorted = filtered.sort((a, b) => b.rYTD - a.rYTD).slice(0, 5);

    const tableBody = document.getElementById("fundTableBody");
    tableBody.innerHTML = sorted.length > 0
      ? sorted.map(f => `
        <tr>
          <td>${f.name}</td>
          <td>${f.industry}</td>
          <td>${f.country}</td>
          <td>${f.stdDev.toFixed(2)}%</td>
          <td>${f.sharpe.toFixed(2)}</td>
          <td>${f.beta.toFixed(2)}</td>
          <td>${f.r3m.toFixed(2)}%</td>
          <td>${f.rYTD.toFixed(2)}%</td>
        </tr>
      `).join("")
      : `<tr><td colspan="8">沒有符合條件的基金</td></tr>`;
  }

  // 綁定選單變更事件
  document.addEventListener("change", function (e) {
    if (e.target.id === "industrySelect" || e.target.id === "countrySelect") {
      filterByDropdowns();
    }
  });




  const contextPrompt = `
內容結構：
開頭
簡要說明本次分析是根據問卷結果進行的個人化建議。
用語溫和專業，建立客戶信任感。
客戶風險分析
清楚列出客戶的：
「總得分」
「風險屬性」（保守型 / 穩健型 / 積極型）
解釋這個風險屬性代表的投資性格，例如承受波動能力、報酬期待、投資心態特性。
推薦基金列表（5檔） 每一檔基金需依照下列方式撰寫一小段文字：
基金名稱。
投資標的或策略概述（例如：主要投資於美國科技股、分散於全球政府公債等）。
適度轉譯關鍵數據指標（如標準差、夏普值、β值）成易懂的說明，連結到客戶的風險屬性。
說明為什麼這檔基金適合客戶的投資偏好與目標。
展望。
（⚡禁止單純列出數字，要解釋數字背後的意義！）
整體總結
概述這組基金配置的邏輯（例如：穩定收益搭配成長潛力／積極型搭配分散風險策略）。
用溫和的口吻提醒客戶：「投資需定期檢視，隨著市場變動或人生目標調整資產配置」。
鼓勵客戶可與財富管理顧問持續合作，掌握最佳布局。
請用繁體中文回答所有問題。
`;

  async function getAIResponse(message) {
    const fundSnippets = csvData.slice(0, 100).map(f =>

      `基金名稱：${f.name}，類型：${f.industry}，地區：${f.country}，標準差：${f.stdDev}%，夏普值：${f.sharpe}，Beta：${f.beta}，今年來報酬率：${f.rYTD}%`
    ).join("\n");

    const riskText = document.getElementById("riskLevel").textContent || "未提供";
    const fullPrompt = `${contextPrompt}

使用者風險屬性為：「${riskText}」


目前推薦基金如下：
${fundSnippets || "（目前尚未有推薦資料）"}

使用者提問：
${message}
`;

    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer 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",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "llama3-8b-8192",
        messages: [
          {
            role: "system",
            content: `你是一位使用繁體中文、口吻專業溫和的財富顧問，請始終用繁體中文回答所有問題，不可使用英文。\n\n${contextPrompt}`
          },
          {
            role: "user",
            content: `以下是使用者的問題，請用繁體中文完整回答：\n${message}`
          }
        ]
        ,

        temperature: 0.5
      })
    });

    const data = await response.json();

    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
      console.error("Groq 回傳內容：", data);
      throw new Error("AI 回傳格式錯誤，伺服器訊息：" + (data.error?.message || "不明錯誤"));
    }
    return data.choices[0].message.content.trim();
  }



  async function sendChat() {
    const chatInput = document.getElementById("chatInput");
    const chatArea = document.getElementById("chatArea");
    const userText = chatInput.value.trim();

    if (currentRecommendations.length === 0) {
      alert("⚠️ 請先完成問卷並產生推薦結果，再進行提問！");
      return;
    }


    if (!userText) return;

    chatArea.innerHTML += `<div><strong>你：</strong>${userText}</div>`;
    chatArea.innerHTML += `<div id="loading">AI：<em>正在思考中...</em></div>`;
    chatInput.value = "";

    try {
      const aiReply = await getAIResponse(userText);
      document.getElementById("loading")?.remove();
      chatArea.innerHTML += `<div><strong>AI：</strong>${aiReply.replace(/\n/g, "<br>")}</div>`;
    } catch (err) {
      chatArea.innerHTML += `<div><strong>AI：</strong>⚠️ 錯誤：${err.message}</div>`;

      console.error("❌ Groq 錯誤訊息：", err);
    }

    chatArea.scrollTop = chatArea.scrollHeight;
  }



</script>




</body>

</html>