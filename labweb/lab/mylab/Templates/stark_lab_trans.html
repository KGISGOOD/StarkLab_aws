<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translator</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .input-group, .output-group {
            margin-bottom: 20px;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #34495e;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-size: 16px;
        }
        select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
            width: 200px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        #speech-btn {
            background-color: #27ae60;
            color: white;
        }
        #speech-btn.recording {
            background-color: #c0392b;
        }
        #translate-btn {
            background-color: #3498db;
            color: white;
        }
        #history-btn {
            background-color: #8e44ad;
            color: white;
        }
        #clear-history-btn {
            background-color: #e74c3c;
            color: white;
        }
        #play-btn {
            background-color: #f1c40f;
            color: white;
        }
        #optimize-btn {
            background-color: #16a085;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
        #result, #history, #optimized-result {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #ecf0f1;
            white-space: pre-wrap;
            min-height: 50px;
        }
        #optimized-result {
            margin-top: 10px;
        }
        h3 {
            color: #2c3e50;
            margin-top: 20px;
            display: inline-block;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ°´åˆ©ç½²ç¿»è­¯ğŸ”</h1>
        <!-- CSRF token -->
        {% csrf_token %}
        
        <div class="input-group">
            <label for="text-input">è¼¸å…¥è¦ç¿»è­¯çš„å…§å®¹:</label>
            <textarea id="text-input" rows="4" placeholder="å¯ä»¥ç”¨æ‰“å­—æˆ–æ˜¯ç”¨ä¸‹é¢èªéŸ³ç¿»è­¯æŒ‰éˆ•ä¾†ç¿»è­¯ï¼ŒSpeechRecognition API æ˜¯åŸºæ–¼ç€è¦½å™¨çš„ Web Speech APIï¼Œæ‰€ä»¥éŒ„éŸ³æ™‚é–“é™åˆ¶1~2åˆ†é˜"></textarea>
            <button id="speech-btn" onclick="toggleSpeechRecognition()">é–‹å§‹éŒ„éŸ³</button>
        </div>
        
        <div class="input-group">
            <label for="source-lang-select">é¸æ“‡åŸå§‹èªè¨€:</label>
            <select id="source-lang-select">
                <option value="zh-TW">ä¸­æ–‡</option>
                <option value="en-US">è‹±æ–‡</option>
                <option value="es-ES">è¥¿ç­ç‰™æ–‡</option>
                <option value="fr-FR">æ³•æ–‡</option>
                <option value="ja-JP">æ—¥æ–‡</option>
            </select>
        </div>
        
        <div class="input-group">
            <label for="target-lang-select">é¸æ“‡è¦ç¿»è­¯çš„èªè¨€:</label>
            <select id="target-lang-select">
                <option value="en">è‹±æ–‡</option>
                <option value="zh-TW">ä¸­æ–‡</option>
                <option value="es">è¥¿ç­ç‰™æ–‡</option>
                <option value="fr">æ³•æ–‡</option>
                <option value="ja">æ—¥æ–‡</option>
            </select>
        </div>
        
        <button id="translate-btn" onclick="translateText()">é–‹å§‹ç¿»è­¯</button>

        <div class="output-group">
            <h3>ç¿»è­¯æ–‡å­—:</h3>
            <button id="play-btn" onclick="playTranslatedText()">æ’­æ”¾è²éŸ³</button>
            <div id="result"></div>
        </div>
        
        <div class="output-group">
            <h3>ç¿»è­¯ç´€éŒ„:</h3>
            <button id="history-btn" onclick="getHistory()">æ­·å²ç´€éŒ„</button>
            <button id="clear-history-btn" onclick="clearHistory()">æ¸…é™¤ç¿»è­¯æ­·å²</button>
            <div id="history"></div>
        </div>
        
        <div class="output-group">
            <h3>å„ªåŒ–ç¿»è­¯:</h3>
            <button id="optimize-btn" onclick="optimizeTranslation()">å„ªåŒ–èªå¥</button>
            <div id="optimized-result"></div>
        </div>
    </div>

    <script>
        // ç²å– CSRF token
        function getCsrfToken() {
            const tokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
            return tokenElement ? tokenElement.value : '';
        }

        // èªéŸ³è½‰æ–‡å­—åŠŸèƒ½
        let recognition;
        let isRecording = false;
        const speechBtn = document.getElementById('speech-btn');
        let fullTranscript = ''; // ç”¨æ–¼å„²å­˜å®Œæ•´çš„èªéŸ³è½‰æ–‡å­—çµæœ

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true; // å•Ÿç”¨æŒçºŒéŒ„éŸ³
            recognition.interimResults = true; // æä¾›å³æ™‚è½‰éŒ„çµæœ

            recognition.onresult = function(event) {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        fullTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                // å³æ™‚æ›´æ–° textareaï¼Œé¡¯ç¤ºå®Œæ•´å’Œè‡¨æ™‚çµæœ
                document.getElementById('text-input').value = fullTranscript + interimTranscript;
            };

            recognition.onend = function() {
                if (!isRecording) { // åªæœ‰æ‰‹å‹•åœæ­¢æ™‚æ‰æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    speechBtn.innerText = 'é–‹å§‹éŒ„éŸ³';
                    speechBtn.classList.remove('recording');
                    document.getElementById('text-input').value = fullTranscript.trim(); // æœ€çµ‚çµæœå»é™¤å¤šé¤˜ç©ºæ ¼
                }
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                alert('èªéŸ³è­˜åˆ¥å¤±æ•—: ' + event.error);
                isRecording = false;
                speechBtn.innerText = 'é–‹å§‹éŒ„éŸ³';
                speechBtn.classList.remove('recording');
                fullTranscript = ''; // é‡ç½®éŒ„éŸ³å…§å®¹
            };
        } else {
            speechBtn.disabled = true;
            speechBtn.innerText = 'èªéŸ³ä¸æ”¯æ´';
            alert('ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥ã€‚');
        }

        function toggleSpeechRecognition() {
            if (!recognition) return;
            const sourceLang = document.getElementById('source-lang-select').value;
            recognition.lang = sourceLang;

            if (isRecording) {
                recognition.stop();
                isRecording = false;
            } else {
                fullTranscript = ''; // é‡ç½®ä¹‹å‰çš„éŒ„éŸ³å…§å®¹
                recognition.start();
                isRecording = true;
                speechBtn.innerText = 'åœæ­¢éŒ„éŸ³';
                speechBtn.classList.add('recording');
            }
        }

        // ç™¼é€ç¿»è­¯è«‹æ±‚
        function translateText() {
            const text = document.getElementById('text-input').value;
            const targetLang = document.getElementById('target-lang-select').value;

            if (!text) {
                alert('è«‹è¼¸å…¥è¦ç¿»è­¯çš„æ–‡å­—ï¼');
                return;
            }
            fetch('http://127.0.0.1:8000/translate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCsrfToken()
                },
                body: `text=${encodeURIComponent(text)}&target_lang=${targetLang}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'ok') {
                    document.getElementById('result').innerText = data.translated_text;
                } else {
                    document.getElementById('result').innerText = 'éŒ¯èª¤: ' + data.error;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('result').innerText = 'ç¿»è­¯å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
            });
        }

        // æ’­æ”¾ç¿»è­¯æ–‡æœ¬çš„èªéŸ³
        function playTranslatedText() {
            const text = document.getElementById('result').innerText;
            const targetLang = document.getElementById('target-lang-select').value;

            if (!text || text.startsWith('éŒ¯èª¤') || text === 'ç¿»è­¯å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚') {
                alert('ç„¡æœ‰æ•ˆæ–‡å­—å¯æ’­æ”¾ï¼');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            switch (targetLang) {
                case 'en': utterance.lang = 'en-US'; break;
                case 'zh-TW': utterance.lang = 'zh-TW'; break;
                case 'es': utterance.lang = 'es-ES'; break;
                case 'fr': utterance.lang = 'fr-FR'; break;
                case 'ja': utterance.lang = 'ja-JP'; break;
                default: utterance.lang = 'en-US';
            }
            window.speechSynthesis.speak(utterance);
        }

        // ç²å–ç¿»è­¯æ­·å²
        function getHistory() {
            fetch('http://127.0.0.1:8000/history/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'ok') {
                    const historyDiv = document.getElementById('history');
                    if (data.conversation.length === 0) {
                        historyDiv.innerText = 'å°šç„¡ç¿»è­¯æ­·å²ã€‚';
                    } else {
                        historyDiv.innerHTML = '';
                        data.conversation.forEach(item => {
                            historyDiv.innerHTML += `<p><strong>åŸæ–‡:</strong> ${item.source_text} <br>
                                                    <strong>ç¿»è­¯ (${item.target_lang}):</strong> ${item.translated_text}</p>`;
                        });
                    }
                } else {
                    document.getElementById('history').innerText = 'è¼‰å…¥æ­·å²å¤±æ•—ã€‚';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('history').innerText = 'ç„¡æ³•è¼‰å…¥æ­·å²ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
            });
        }

        // æ¸…é™¤ç¿»è­¯æ­·å²
        function clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤ç¿»è­¯æ­·å²å—ï¼Ÿ')) {
                fetch('http://127.0.0.1:8000/history/', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        document.getElementById('history').innerText = 'ç¿»è­¯æ­·å²å·²æˆåŠŸæ¸…é™¤ã€‚';
                        getHistory();
                    } else {
                        document.getElementById('history').innerText = 'éŒ¯èª¤: ' + data.error;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('history').innerText = 'ç„¡æ³•æ¸…é™¤æ­·å²ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
                });
            }
        }

        // å„ªåŒ–ç¿»è­¯å¾Œçš„æ–‡å­—åŠŸèƒ½ï¼ˆgrok_aiï¼‰
        function optimizeTranslation() {
            const translatedText = document.getElementById('result').innerText;
            const targetLang = document.getElementById('target-lang-select').value;

            if (!translatedText || translatedText.startsWith('éŒ¯èª¤') || translatedText === 'ç¿»è­¯å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚') {
                alert('è«‹å…ˆé€²è¡Œç¿»è­¯ä»¥ç²å–è¦å„ªåŒ–çš„æ–‡å­—ï¼');
                return;
            }

            const prompt = `Optimize the following translated text: "${translatedText}" in its target language (${targetLang}). The optimized version should improve clarity, fluency, or readability while maintaining the original meaning. Return only the optimized text without additional explanation.`;

            const apiKey = 'xai-sEKM3YfLj81l66aMWyXpmasF8Xab7hvpcwtEY4WU0jIeJfEoWDPSjm5VjbH9bq9JDNN5SmAAIrGyjfPN'; // è«‹æ›¿æ›ç‚ºä½ çš„ xAI API key
            const apiUrl = 'https://api.x.ai/v1/chat/completions'; // xAI API ç«¯é»

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'grok-beta',
                    messages: [
                        { role: 'system', content: 'ä½ æ˜¯ä¸€å€‹æ–‡å­—å„ªåŒ–åŠ©æ‰‹ï¼Œå¹«æˆ‘å„ªåŒ–ç¿»è­¯å¾Œçš„å…§å®¹.' },
                        { role: 'user', content: prompt }
                    ],
                    max_tokens: 150,
                    temperature: 0.7
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const optimizedText = data.choices[0].message.content;
                document.getElementById('optimized-result').innerText = optimizedText;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('optimized-result').innerText = 'ç„¡æ³•å„ªåŒ–ç¿»è­¯æ–‡å­—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
            });
        }
    </script>
</body>
</html>